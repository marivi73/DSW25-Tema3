<?php
namespace Dsw\Blog\DAO;

use DateTime;
use Dsw\Blog\Models\User;
use PDO;

class UserDao {
    public function __construct(
        private PDO $conn
    )
    {}

    public function get($id): ?User {
        $sql = 'SELECT * FROM user WHERE id = :id';
        $stmt = $this->conn->prepare($sql);
        $stmt->execute(['id' => $id]);
        $register = $stmt->fetch();
        if ($register) {
            return new User($id, $register['name'], $register['email'], new DateTime($register['register_date']));
        }
        return null;
    }

    public function getAll(): array {
        $users = [];
        $sql = "SELECT * FROM user";
        $stmt = $this->conn->prepare($sql);
        $stmt->execute();
        $registers = $stmt->fetchAll();
        foreach($registers as $register){
            $users[] = new User($register['id'], $register['name'], $register['email'], new DateTime($register['register_date']));
        }
        return $users;
    }

    public function delete(int $id): void {
        $sql = "DELETE FROM users WHERE id = :id";
        $stmt = $this->conn->prepare($sql);
        $stmt->execute(['id' => $id]);
    }

    public function update(User $user){
        $sql = "UPDATE users SET name =: name, email =: email WHERE id =: id";
        $stmt = $this->conn->prepare($sql);

        $stmt->execute([
            'id' => $user->getId(),
            'name' => $user->getName(),
            'email' => $user->getEmail()
        ]);
    }

    public function create(User $user): User {
        $sql = "INSERT INTO user (name, email) VALUES(:name, :email)";
        $stmt = $this->conn->prepare($sql);
        $stmt->execute([
            'name' => $user->getName(),
            'email' => $user->getEmail()
        ]);
        $user->setId($this->conn->lastInsertId());
        return $user;
    }
}